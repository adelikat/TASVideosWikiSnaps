4
[h3 id=GameObjectives 
	" Game objectives
	$LF
]h3
[ul 
	[li 
		" Emulator used: BizHawk 2.9.1 (NesHawk core)
		$LF
	]li
	[li 
		" Aims for fastest time
		$LF
	]li
]ul
[div class=p 
	"This run beats NES Flipull "Normal" mode in about 25:34. This is faster than 
	[a href=https://tasvideos.org/UserFiles/Info/638218390079846084 rel=noopener external nofollow 
		"my previous casual TAS
	]a
	" by about 7 minutes. (Note that the old run has some advantages, because it starts from the stage 201 with an 
	[a href=https://gamefaqs.gamespot.com/nes/579524-flipull-an-exciting-cube-game/cheats rel=noopener external nofollow 
		"in-game code
	]a
	" and the game timer ticks faster)
	$LF
]div
[div class=p 
	"I used v1.0 of this game. There also seems to be v1.1, but I don't know anything about differences between them.
	$LF
]div
[div class=p 
	"The RNG of this game depends on CPU cycles, so I used NesHawk for accuracy.
	$LF
]div
[div class=p 
	"I used Lua bots to manipulate the RNG. The re-record count doesn't include trial-and-errors made by the bots.
	$LF
]div
[h3 id=AboutTheGame 
	" About the game
	$LF
]h3
[div class=p 
	""Flipull" is a simple puzzle game. The game objective is erase a pile of blocks. You always have a block and can throw it. When a thrown block collides with the same kind blocks, they will be erased. Afterwards, when a thrown blocks collides with the different kind block, they are swapped. This game was never released outside Japan.
	$LF
]div
[div class=p 
	"This game has two modes, "Normal" and "Advance". In the normal mode, blocks are placed randomly. In the advance mode, placements of blocks are completely fixed.
	$LF
]div
[div class=p 
	"The normal mode has 50 stages.
	$LF
]div
[h3 id=Comments 
	" Comments
	$LF
]h3
[div class=p 
	"I wrote 
	[a href=https://github.com/taotao54321/FlipullSolver rel=noopener external nofollow 
		"a solver
	]a
	" to beat a stage generated by a specified RNG value with a minimum frame cost.
	$LF
]div
[div class=p 
	"I examined the frame costs for throwing a block with 
	[a href=https://gist.github.com/taotao54321/6a4cd1bbc4345cf4bd4c42d2babb6e16 rel=noopener external nofollow 
		"a Lua script
	]a
	".
	$LF
	"By the way, if some blocks remain when you beat a stage, it takes 11 frames per block to erase them automatically. And, if you achieve "perfect clear" in a stage, it takes 96 frames for a fireworks effect.
	$LF
]div
[div class=p 
	"Every stage has a specific number of blocks to beat it. If you beat a stage with exactly the required block count, it is called "just clear". "just clear" doesn't take any additional frame cost.
	$LF
	"Intuitively, you might think that it is always optimal to beat stages with "just clear". But for a certain reason, I often avoid "just clear" and also avoid erasing 5 or more blocks at once. This is related to the RNG (I will describe details later).
	$LF
]div
[div class=p 
	"Note: in the NES version, if you have only moves which directly hits a wildcard block, it is considered a miss. (This point is different from the GB version).
	$LF
]div
[h4 id=AboutTheRng 
	" About the RNG
	$LF
]h4
[div class=p 
	"In the normal mode, each stage has 65536 or 65535 placements which is determined by the RNG seeds.
	$LF
]div
[div class=p 
	"This game has a very ad-hoc RNG, and you have to manipulate it carefully.
	$LF
]div
[div class=p 
	"In this game, all the logics are processed within the NMI thread, while the main thread only updates the RNG state and increment the mainloop counter in an infinite loop. So, the RNG is sensitive to CPU cycles.
	$LF
	"Here is the infinite loop of the main thread (
	[code 
		"rand
	]code
	" is at 
	[code 
		"$0122
	]code
	"):
	$LF
]div
[pre 
	"@mainloop:
	$LF
	"        lda     rand
	$LF
	"        tax
	$LF
	"        lda     0,x
	$LF
	"        adc     rand
	$LF
	"        sta     rand
	$LF
	"        adc     rand+1
	$LF
	"        sbc     #$11
	$LF
	"        sta     rand+1
	$LF
	$LF
	"        inc     mainloop_counter
	$LF
	$LF
	"        jmp     @mainloop
	$LF
]pre
[div class=p 
	"As you see, this game updates the RNG using the contents of the zeropage.
	$LF
	"Note that the addition 
	[code 
		"rand[0] = adc(rand[0], mem[rand[0]])
	]code
	". This adc instruction involves carry in many cases.
	$LF
]div
[div class=p 
	"This game manages each players' inputs at $F3-$F8. So, if you can make rand[0] point to one of these addresses, you can manipulate the RNG by inputs. But, depending on the contents of the zeropage, this manipulation is not always possible.
	$LF
]div
[div class=p 
	"For example, let's assume that rand[0] has value 0x70 and the zeropage is like below:
	$LF
]div
[pre 
	"      x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE xF
	$LF
	"...
	$LF
	"0x70: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 F1
	$LF
	"...
	$LF
]pre
[div class=p 
	"In this case, the result of adc(0x70, 0) is 0x70 or 0x71, so rand[0] will continue to be incremented a bit slowly. When rand[0] reaches 0x7F, adc(0x7F, 0xF1) is 0x70 or 0x71, so rand[0] "loops" to 0x70 or 0x71.
	$LF
	"If such a loop occurs, it limits the range of the RNG state. So, if necessary, you have to manipulate to prevent such cases from occuring.
	$LF
]div
[div class=p 
	"Especially, if the pattern [0x00, 0xFF] appears on the zeropage, rand[0] will be "stabilized" there.
	$LF
	"In fact, this pattern can appear at $D4-$D5. $D5 is the flag which indicates that a wildcard block will be appear on the board at the next stage, and it will always be 0xFF if you erase 5 or more blocks at once. So basically, you should not erase 5 or more blocks at once, except the last stage. (If you erase 3 or 4 blocks at once, $D5 can probabilistically be 0xFF depending on the mainloop counter, but you can easily manipulate this)
	$LF
]div
[div class=p 
	"And, if you achieve "just clear", $E9 will be set to 0x80 later, and it makes difficult for rand[0] to reach $F3-.
	$LF
	"Especially, from stage 11 to stage 30, it is very difficult to manipulate the RNG in this condition due to the contents of the zeropage. So, I often avoided "just clear".
	$LF
]div
[div class=p 
	"By the way, you can also cause the RNG stabilization intentionally with your inputs, and it is sometimes useful to manipulate the RNG. For example, when the player1 inputs nothing and the player2 inputs all the keys, the [0x00, 0xFF] pattern will appear at $F3-$F4, allowing you to stabilize the RNG at these addresses.
	$LF
]div
[h3 id=StageByStageComments 
	" Stage by stage comments
	$LF
]h3
[div class=p 
	"Some RNG seeds might be impossible (but I'm not sure).
	$LF
]div
[div class=p 
	"The stage placement loops every 32 stages, but sometimes I couldn't manipulate the RNG in the same way due to the difference of the zeropage.
	$LF
]div
[div class=p 
	"From stage 10 to stage 29, I didn't consider "just clear", because it makes the next RNG manipulation very difficult.
	$LF
]div
[div class=p 
	"I treated the stage 50 specially. It takes no block throwing cost for the last move, and you can erase 5 or more blocks at once.
	$LF
]div
[div class=p 
	"The numbers after RNG seeds are their frame costs. Frame costs doesn't include the costs for converting time into score.
	$LF
]div
[table 
	[tbody 
		[tr 
			[th 
				"Stage
			]th
			[th 
				"RNG
			]th
			[th 
				"Note
			]th
		]tr
		[tr 
			[td 
				"1
			]td
			[td 
				"0x89A2 (669)
			]td
			[td 
				"best in just clear.
			]td
		]tr
		[tr 
			[td 
				"2
			]td
			[td 
				"0x89A2 (669)
			]td
			[td 
				"2nd best in just clear. best: 0xC558 (642)
			]td
		]tr
		[tr 
			[td 
				"3
			]td
			[td 
				"0xA9C4 (757)
			]td
			[td 
				"5th best in just clear. best: 0xEA18 (708)
			]td
		]tr
		[tr 
			[td 
				"4
			]td
			[td 
				"0xCA36 (971)
			]td
			[td 
				"best in just clear.
			]td
		]tr
		[tr 
			[td 
				"5
			]td
			[td 
				"0xD03F (1228)
			]td
			[td 
				"24th best in just clear. best: 0x40BD (1122)
			]td
		]tr
		[tr 
			[td 
				"6
			]td
			[td 
				"0x9E16 (1066)
			]td
			[td 
				"8th best in just clear. best: 0x1817 (1022)
			]td
		]tr
		[tr 
			[td 
				"7
			]td
			[td 
				"0x79D8 (1108)
			]td
			[td 
				"best in just clear.
			]td
		]tr
		[tr 
			[td 
				"8
			]td
			[td 
				"0xAB19 (1424)
			]td
			[td 
				"best in non-just clear. best in just clear: 0xEB16 (1275)
			]td
		]tr
		[tr 
			[td 
				"9
			]td
			[td 
				"0xE028 (1318)
			]td
			[td 
				"best in non-just clear. best in just clear: 0x02D6 (1307)
			]td
		]tr
		[tr 
			[td 
				"10
			]td
			[td 
				"0xE028 (1318)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"11
			]td
			[td 
				"0xEB16 (1275)
			]td
			[td 
				"best in non-just clear. (and better than any just clear)
			]td
		]tr
		[tr 
			[td 
				"12
			]td
			[td 
				"0xB1A9 (1327)
			]td
			[td 
				"4th best in non-just clear. best in non-just clear: 0xF9CE (1253)
			]td
		]tr
		[tr 
			[td 
				"13
			]td
			[td 
				"0xA2BF (1392)
			]td
			[td 
				"2nd best in non-just clear. best in non-just clear: 0x518D (1376)
			]td
		]tr
		[tr 
			[td 
				"14
			]td
			[td 
				"0xA3EF (1423)
			]td
			[td 
				"2nd best in non-just clear. best in non-just clear: 0x518D (1376)
			]td
		]tr
		[tr 
			[td 
				"15
			]td
			[td 
				"0xB439 (1589)
			]td
			[td 
				"2nd best in non-just clear. best in non-just clear: 0x315D (1551)
			]td
		]tr
		[tr 
			[td 
				"16
			]td
			[td 
				"0xE69B (1092)
			]td
			[td 
				"3rd best in non-just clear. best in non-just clear: 0x58F7 (1045)
			]td
		]tr
		[tr 
			[td 
				"17
			]td
			[td 
				"0x9B85 (1134)
			]td
			[td 
				"4th best in non-just clear. best in non-just clear: 0xC777 (1096)
			]td
		]tr
		[tr 
			[td 
				"18
			]td
			[td 
				"0x3A3B (1456)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"19
			]td
			[td 
				"0xE69B (1092)
			]td
			[td 
				"3rd best in non-just clear. best in non-just clear: 0x58F7 (1045)
			]td
		]tr
		[tr 
			[td 
				"20
			]td
			[td 
				"0xB31F (1270)
			]td
			[td 
				"3rd best in non-just clear. best in non-just clear: 0xFE0B (1259)
			]td
		]tr
		[tr 
			[td 
				"21
			]td
			[td 
				"0xBE5F (1191)
			]td
			[td 
				"2nd best in non-just clear. best in non-just clear: 0xC6BC (1138)
			]td
		]tr
		[tr 
			[td 
				"22
			]td
			[td 
				"0xE78C (1509)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"23
			]td
			[td 
				"0x58F7 (1175)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"24
			]td
			[td 
				"0xAB19 (1449)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"25
			]td
			[td 
				"0xA2BF (1429)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"26
			]td
			[td 
				"0xA2BF (1429)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"27
			]td
			[td 
				"0xAB19 (1449)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"28
			]td
			[td 
				"0xAB19 (1449)
			]td
			[td 
				"best in non-just clear.
			]td
		]tr
		[tr 
			[td 
				"29
			]td
			[td 
				"0xE156 (1790)
			]td
			[td 
				"2nd best in non-just clear. best in non-just clear: 0x693D (1780)
			]td
		]tr
		[tr 
			[td 
				"30
			]td
			[td 
				"0xD701 (1278)
			]td
			[td 
				"2nd best in just clear. best: 0x30E0 (1217)
			]td
		]tr
		[tr 
			[td 
				"31
			]td
			[td 
				"0xE69B (1092)
			]td
			[td 
				"3rd best in just clear. best: 0x58F7 (1045)
			]td
		]tr
		[tr 
			[td 
				"32
			]td
			[td 
				"0xE69B (1092)
			]td
			[td 
				"3rd best in just clear. best: 0x58F7 (1045)
			]td
		]tr
		[tr 
			[td 
				"33
			]td
			[td 
				"0x89A2 (669)
			]td
			[td 
				"best in just clear.
			]td
		]tr
		[tr 
			[td 
				"34
			]td
			[td 
				"0x89A2 (669)
			]td
			[td 
				"2nd best in just clear. best: 0xC558 (642)
			]td
		]tr
		[tr 
			[td 
				"35
			]td
			[td 
				"0xBB87 (768)
			]td
			[td 
				"7th best in just clear. best: 0xEA18 (708)
			]td
		]tr
		[tr 
			[td 
				"36
			]td
			[td 
				"0xAE67 (1014)
			]td
			[td 
				"best in non-just clear. best in just clear: 0xCA36 (971)
			]td
		]tr
		[tr 
			[td 
				"37
			]td
			[td 
				"0xF0EB (1124)
			]td
			[td 
				"best in non-just clear. best in just clear: 0x40BD (1122)
			]td
		]tr
		[tr 
			[td 
				"38
			]td
			[td 
				"0xC6BC (1048)
			]td
			[td 
				"4th best in just clear. best: 0x1817 (1022)
			]td
		]tr
		[tr 
			[td 
				"39
			]td
			[td 
				"0x79D8 (1108)
			]td
			[td 
				"best in just clear.
			]td
		]tr
		[tr 
			[td 
				"40
			]td
			[td 
				"0xEB16 (1275)
			]td
			[td 
				"best in just clear.
			]td
		]tr
		[tr 
			[td 
				"41
			]td
			[td 
				"0xA2BF (1392)
			]td
			[td 
				"5th best in non-just clear. best in just clear: 0x02D6 (1307), best in non-just clear: 0xE028 (1318)
			]td
		]tr
		[tr 
			[td 
				"42
			]td
			[td 
				"0xB970 (1306)
			]td
			[td 
				"best in just clear.
			]td
		]tr
		[tr 
			[td 
				"43
			]td
			[td 
				"0xEB16 (1275)
			]td
			[td 
				"best in non-just clear. (and better than any just clear)
			]td
		]tr
		[tr 
			[td 
				"44
			]td
			[td 
				"0x46F7 (1254)
			]td
			[td 
				"2nd best in non-just clear. best in just clear: 0x79D8 (1108), best in non-just clear: 0xF9CE (1253)
			]td
		]tr
		[tr 
			[td 
				"45
			]td
			[td 
				"0xA2BF (1392)
			]td
			[td 
				"2nd best in non-just clear. best in just clear: 0xE028 (1318), best in non-just clear: 0x518D (1376)
			]td
		]tr
		[tr 
			[td 
				"46
			]td
			[td 
				"0xA2BF (1429)
			]td
			[td 
				"3rd best in non-just clear. best in just clear: 0xE028 (1318), best in non-just clear: 0x518D (1376)
			]td
		]tr
		[tr 
			[td 
				"47
			]td
			[td 
				"0x315D (1551)
			]td
			[td 
				"best in non-just clear. best in just clear: 0x315D (1443) (the same RNG!)
			]td
		]tr
		[tr 
			[td 
				"48
			]td
			[td 
				"0x58F7 (1045)
			]td
			[td 
				"best in non-just clear. best in just clear: 0xAE67 (1014)
			]td
		]tr
		[tr 
			[td 
				"49
			]td
			[td 
				"0xC777 (1096)
			]td
			[td 
				"best in non-just clear. best in just clear: 0x4A74 (1056)
			]td
		]tr
		[tr 
			[td 
				"50
			]td
			[td 
				"0xAA44 (1170)
			]td
			[td 
				"best.
			]td
		]tr
	]tbody
]table
[h3 id=PossibleImprovements 
	" Possible improvements
	$LF
]h3
[div class=p 
	"I think my RNG manipulation is probably not theoretically perfect. But I believe you cannot improve this run without an understanding of the RNG and some computing resources.
	$LF
]div
[hr 
]hr
[div class=p 
	[a class=intlink href=/Users/Profile/ThunderAxe31 
		"ThunderAxe31
	]a
	": Claiming for judging.
	$LF
]div
[div class=p 
	[a class=intlink href=/Users/Profile/ThunderAxe31 
		"ThunderAxe31
	]a
	": Oh boy, this looks extremely optimized. Great job! Accepting as a new branch.
	$LF
]div
[hr 
]hr
[div class=p 
	[a class=intlink href=/Users/Profile/despoa 
		"despoa
	]a
	": Processing...
]div
