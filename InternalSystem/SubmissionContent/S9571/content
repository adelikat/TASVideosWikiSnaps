10
[div class=p 
	"This run beats NES (Famicom) "Hokuto no Ken 4: Shichisei Hakenden: Hokuto Shinken no Kanata e" in about 7m15s, using "moonwalk glitch" and "talking ship glitch".
	$LF
]div
[h3 id=GameObjectives 
	" Game objectives
	$LF
]h3
[ul 
	[li 
		" Headerless ROM hash: SHA1:c6fef52264372fab620d1e5ee6a3e60e46262775
		$LF
	]li
	[li 
		" Emulator used: BizHawk 2.10 (NesHawk core)
		$LF
	]li
	[li 
		" Aims for fastest time
		$LF
	]li
	[li 
		" Major skip glitch
		$LF
	]li
]ul
[h3 id=AboutTheGame 
	" About the game
	$LF
]h3
[div class=p 
	""Hokuto no Ken 4: Shichisei Hakenden: Hokuto Shinken no Kanata e" is a sequel to 
	[a href=https://tasvideos.org/2351G rel=noopener external nofollow 
		"Hokuto no Ken 3
	]a
	". This game is a typical JRPG that features many original characters not present in the source material. Unfortunately, this game seems not so highly rated mainly due to its repetitiveness.
	$LF
]div
[div class=p 
	"This game was never released outside Japan.
	$LF
]div
[h3 id=RunOverview 
	" Run overview
	$LF
]h3
[h4 id=Opening 
	" Opening
	$LF
]h4
[div class=p 
	"I start the game with savedata 1, setting the message speed to "fast".
	$LF
	"I name the hero "ゃ" for a game end glitch.
	$LF
]div
[h4 id=Maleid 
	" Maleid (マレード)
	$LF
]h4
[div class=p 
	"I escape from the town quickly using the moonwalk glitch.
	$LF
	"In this run, I abuse this glitch to travel freely.
	$LF
]div
[div class=p 
	"I go to Monpasa.
	$LF
]div
[h4 id=Monpasa 
	" Monpasa (モンパサ)
	$LF
]h4
[div class=p 
	"I buy a leather shoes (かわのくつ) for a game end glitch.
	$LF
]div
[div class=p 
	"I go to Legenda.
	$LF
]div
[h4 id=Legenda 
	" Legenda (レジェンダ)
	$LF
]h4
[div class=p 
	"I talk to two children to enable the event flags for a game end glitch.
	$LF
]div
[div class=p 
	"I go to Cave to Nanto continent. On the way, I equip the leather shoes (かわのくつ) while manipulating a random encounter.
	$LF
]div
[h4 id=CaveToNantoContinent 
	" Cave to Nanto continent
	$LF
]h4
[div class=p 
	"I open a trapped chest, and fall to Ghosdoom Prison B3F.
	$LF
]div
[h4 id=GhosdoomPrisonThisIsUnpronounceableEvenForJapanese 
	" Ghosdoom Prison (ゴズデーュム ろうごく (this is unpronounceable even for Japanese))
	$LF
]h4
[div class=p 
	"I talk to three prisoners on B3F to enable the event flags for a game end glitch.
	$LF
]div
[div class=p 
	"Note: when I talk to the third prisoner, I took a wrong route and wasted one frame.
	$LF
	"But, I couldn't save any frame by fixing this due to a random encounter after taking the stairs.
	$LF
]div
[div class=p 
	"If you escape this prison with the moonwalk glitch, you will be brought back to the cave entrance. So, I escape through the valid exit.
	$LF
]div
[div class=p 
	"I go to Suichou.
	$LF
]div
[h4 id=Suichou 
	" Suichou (スイチョウ)
	$LF
]h4
[div class=p 
	"I talk to four people to enable the event flags for a game end glitch.
	$LF
]div
[div class=p 
	"I save the game in the training center. This is to take advantage of a memory region in savedata 1 for a game end glitch.
	$LF
]div
[div class=p 
	"I go to Crosstown.
	$LF
]div
[h4 id=Crosstown 
	" Crosstown (クロスタウン)
	$LF
]h4
[div class=p 
	"I talk to a woman to enable the event flag needed to activate a game end glitch.
	$LF
]div
[div class=p 
	"I go to Southbass.
	$LF
]div
[h4 id=Southbass 
	" Southbass (サウスバース)
	$LF
]h4
[div class=p 
	"I talk to a person in a house to load a phrase pointer for a game end glitch.
	$LF
]div
[div class=p 
	"I go to Galgtown to obtain a ship.
	$LF
]div
[div class=p 
	"Note: I couldn't use Oupa's pirate ship. To obtain the pirate ship, you need to add Misshu (ミッシュ) to your party, but it prevents the execution of my game end glitch.
	$LF
]div
[h4 id=Galgtown 
	" Galgtown (ガルグタウン)
	$LF
]h4
[div class=p 
	"I obtain a ship with the moonwalk glitch.
	$LF
]div
[div class=p 
	"I stay on the ship and go to Raflens with the moonwalk glitch.
	$LF
]div
[h4 id=Raflens 
	" Raflens (ラフレンス)
	$LF
]h4
[div class=p 
	"I get off the ship, and execute the menu command "stats" (つよさ) to display the text "leather shoes" (かわのくつ).
	$LF
]div
[div class=p 
	"I talk to the ship (this is the talking ship glitch). The game shows some glitchy text for a while, and shows an ending trigger message (a conversation between Kenshiro and Ryudo). This enables the ending flag, and the game executes the ending scene.
	$LF
]div
[h3 id=MoonwalkGlitch 
	" Moonwalk glitch
	$LF
]h3
[div class=p 
	[a href=https://www.nicovideo.jp/watch/sm43281068 rel=noopener external nofollow 
		"Digest video
	]a
	" (Japanese)
	$LF
]div
[div class=p 
	"If you press Up+Down or Left+Right, the hero does moonwalk.
	$LF
]div
[ul 
	[li 
		" If you press U+D, the hero appears to move down, but actually he moves up.
		$LF
	]li
	[li 
		" If you press L+R, the hero appears to move left, but actually he moves right.
		$LF
	]li
]ul
[div class=p 
	"And, when the hero does moonwalk, collisions with obstacles are detected based on the terrain on screen, rather than the map data. As a result, you can pass through many obstacles with this glitch.
	$LF
]div
[div class=p 
	"This glitch allows you to move almost freely upward or rightward. But if you move downward or leftward, there are some restrictions (you can pass through two obstacle squares at most).
	$LF
]div
[div class=p 
	"Other notes:
	$LF
]div
[ul 
	[li 
		" You cannot pass through NPCs with the moonwalk glitch.
		$LF
	]li
	[li 
		" To talk to a shop master, there must be a table between the hero and the shop master on screen.
		$LF
	]li
]ul
[h3 id=TalkingShipGlitch 
	" Talking ship glitch
	$LF
]h3
[div class=p 
	[a href=https://taotao54321.github.io/blog/nes-hokuto4-talking-ship-glitch/ rel=noopener external nofollow 
		"My blog post
	]a
	" (Japanese)
	$LF
]div
[div class=p 
	"In this game, when you talk to a ship, it says a completely unrelated message due to a bug.
	$LF
]div
[div class=p 
	"The cause of this bug is that the game includes ships as talk targets. This game doesn't expect you talk to a ship, so if you do it, the game reads a pointer from out of bounds of the talk table for the current place (for the table, see PRG 9 $AA10).
	$LF
]div
[div class=p 
	"If you talk to a ship in overworld, it just says a message intended for a person in Bahamon (バハモン).
	$LF
	"But, if you perform the moonwalk glitch on a ship, you can bring the ship to other places. If you talk to the ship in this condition, the conversation changes depending on the place ID ($9A).
	$LF
]div
[div class=p 
	"In some places, talk script pointer points to RAM area, which sometimes causes quite glitchy behaviour.
	$LF
	"In this run, I perform the talking ship glitch in Raflens (ラフレンス) to execute $6D- as a talk script.
	$LF
]div
[h3 id=GameEndGlitch 
	" Game end glitch
	$LF
]h3
[div class=p 
	"The final goal is to execute the text script ID 0x00A0 (a conversation between Kenshiro and Ryudo). Once this is executed, the game enables the ending flag ($ED), and the ending scene is triggered immediately after the text processing is completed.
	$LF
]div
[div class=p 
	"First, I explain about some memory:
	$LF
]div
[table 
	[tbody 
		[tr 
			[th 
				"addr
			]th
			[th 
				"type
			]th
			[th 
				"description
			]th
		]tr
		[tr 
			[td 
				"$6C
			]td
			[td 
				"ptr
			]td
			[td 
				""menu command function pointer". In this run, I use the value 0x9C1F (corresponding to the menu command "stats" (つよさ)).
			]td
		]tr
		[tr 
			[td 
				"$6E
			]td
			[td 
				"ptr
			]td
			[td 
				"previous text script pointer.
			]td
		]tr
		[tr 
			[td 
				"$70
			]td
			[td 
				"ptr
			]td
			[td 
				"previous phrase (frequently used word) pointer.
			]td
		]tr
		[tr 
			[td 
				"$72
			]td
			[td 
				"u8
			]td
			[td 
				"zero when I perform the talking ship glitch.
			]td
		]tr
		[tr 
			[td 
				"$6080-$6089
			]td
			[td 
				"u8[2*5]
			]td
			[td 
				"the hero name.
			]td
		]tr
		[tr 
			[td 
				"$6221-$6320
			]td
			[td 
				"u8[0x100]
			]td
			[td 
				"event flags (bitset).
			]td
		]tr
		[tr 
			[td 
				"$644A-$6813
			]td
			[td 
				"u8[0x3CA]
			]td
			[td 
				"savedata 1 (copied from $6080-$6449, basically).
			]td
		]tr
		[tr 
			[td 
				"$65EB-$66EA
			]td
			[td 
				"u8[0x100]
			]td
			[td 
				"event flags in savedata 1.
			]td
		]tr
	]tbody
]table
[div class=p 
	"When I talk to the ship in Raflens, the game reads a pointer $106D from out of bounds of the talk table of Raflens (PRG 9 $B0E0). This is the 
	[a href=https://www.nesdev.org/wiki/Mirroring#Memory_Mirroring rel=noopener external nofollow 
		"mirror
	]a
	" of $6D, so the game executes $6D- as a talk script.
	$LF
]div
[div class=p 
	"A talk script is an array of conditional talks, and it executes the first talk whose condition is met.
	$LF
]div
[div class=p 
	"Conditional talks have a structure as follows:
	$LF
]div
[table 
	[tbody 
		[tr 
			[th 
				"type
			]th
			[th 
				"description
			]th
		]tr
		[tr 
			[td 
				"u16le
			]td
			[td 
				"header word (bit0-11:event flag ID of condition, bit12-15:text script count)
			]td
		]tr
		[tr 
			[td 
				"u16le[]
			]td
			[td 
				"array of text script ID
			]td
		]tr
	]tbody
]table
[div class=p 
	"Notes:
	$LF
]div
[ul 
	[li 
		" If a conditional talk has a text script count of 0, the talk script aborts at that point.
		$LF
	]li
	[li 
		" If a conditional talk has a nonzero text script count and event flag ID 0, it is executed unconditionally.
		$LF
	]li
]ul
[div class=p 
	"It will be easier to understand with the actual example in this run. Here is a memory dump of the moment I talk to the ship in Raflens:
	$LF
]div
[pre 
	"      x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE xF
	$LF
	"=====================================================
	$LF
	"0x60  .. .. .. .. .. .. .. .. .. .. .. .. 1F 9C 21 A3
	$LF
	"0x70  70 92 00 .. .. .. .. .. .. .. .. .. .. .. .. ..
	$LF
]pre
[ul 
	[li 
		" The talk script starts at $6D, so $6C can be ignored.
		$LF
	]li
	[li 
		" $6D-$6E (0x219C) is a header word of the conditional talk. This conditional talk has 2 text scripts and will be executed if the event flag 0x19C is enabled.
		$LF
	]li
	[li 
		" $6F-$70 (0x70A3) is the first text script ID of the conditional talk.
		$LF
	]li
	[li 
		" $71-$72 (0x0092) is the second text script ID of the conditional talk, but actually this value itself can be ignored (more details later).
		$LF
	]li
]ul
[div class=p 
	"In this run, I enabled the event flag 0x19C by talking to a woman in Crosstown. So, this conditional talk will be executed.
	$LF
]div
[div class=p 
	"The text script ID 0x70A3 is invalid, so the game reads the corresponding text script pointer from out of a table (PRG 4 $8304). In this case, the text script pointer is read from $644A (the hero name in savedata 1). I named the hero "ゃ" ([0x00, 0x66]), so the game executes $6600- as a text script.
	$LF
]div
[div class=p 
	"$6600 points to the middle of the event flag bitset in savedata 1. In this run, I talked to many NPCs and wrote [0xF8, 0xB4] to $6617-$6618 (copied from $624D-$624E during saving). This is a text script command, and it means "output the phrase ID 0x1B4". So, the text script outputs it and terminates at 0xFF (finish command) at some point.
	$LF
]div
[div class=p 
	"The phrase ID 0x1B4 is also invalid, so the game reads the corresponding phrase pointer from out of a table (PRG 4 $8000). In this case, the phrase pointer becomes 0xA03D. And, "previous phrase pointer" ($70-$71) is overwritten with this value. As a result, the next text script ID becomes 0x00A0 (which is why the original value of $71 can be ignored). This means the win condition is met.
	$LF
]div
[div class=p 
	"Now, I explain how I build the memory content of $6D- shown above.
	$LF
]div
[div class=p 
	"First, my party must be solo, because the previous phrase pointer will be overwritten when I open the menu if I have any allies.
	$LF
]div
[div class=p 
	"$6C-$6D becomes 0x9C1F when I execute the menu command "stats" (つよさ). And, this command shows the hero's equipment, so $6E-$6F becomes 0xA321, the text script pointer of the text script ID 0x2D1 ("leather shoes" (かわのくつ)). This text script is useful because it doesn't contain any phrase and it doesn't clobber the previous phrase pointer.
	$LF
]div
[div class=p 
	"0x9270 on $70-$71 is the phrase pointer of the phrase ID 0x101 ("とは "). This is generated from the message of the person in Southbass (かんきんされているこ
	[b 
		""とは "
	]b
	"わかったんだ).
	$LF
]div
[div class=p 
	"There are many other combinations of text scripts and phrases. But so far, I have found only one acceptable solution.
	$LF
]div
[h3 id=PossibleImprovements 
	" Possible improvements
	$LF
]h3
[div class=p 
	"The talking ship glitch is so complicated that I'm not confident my solution is optimal. You might be able to find a better solution with some deeper investigation.
	$LF
]div
[hr 
]hr
[div class=p 
	[a class=intlink href=/Users/Profile/DrD2k9 
		"DrD2k9
	]a
	": Claiming for judging.
	$LF
]div
[div class=p 
	[a class=intlink href=/Users/Profile/DrD2k9 
		"DrD2k9
	]a
	": Obviously, a very well planned and executed run.  Accepting!
	$LF
]div
[hr 
]hr
[div class=p 
	[a class=intlink href=/Users/Profile/despoa 
		"despoa
	]a
	": Processing...
]div
