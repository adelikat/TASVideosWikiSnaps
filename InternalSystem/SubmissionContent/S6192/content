11
[p 
	"Video link: https://archive.org/details/megamanpc-tas-1_46_941 (enable captions).
	$LF
]p
[p 
	"Mega Man PC is a better game than people give it credit for,
	$LF
	"and it's more fun to play fast than slow.
	$LF
	"So let's play it fast!
	$LF
	"This submission improves on 
	(__wikiLink|/2247M|2247M)
	" by 2565 frames (36.597 s or 25%),
	$LF
	"chiefly thanks to a new trick that skips almost all of Volt Man's stage.
	$LF
	"In addition,
	$LF
	"a number of minor tricks,
	$LF
	"improved strategies,
	$LF
	"RNG manipulation,
	$LF
	"and overall clean execution
	$LF
	"have shortened the other stages by an average of 8%.
	$LF
]p
[p 
	"The game runs too fast (comically fast)
	$LF
	"even on the slowest CPU settings of JPC-RR.
	$LF
	"That's why there are alternative versions of the video.
	$LF
	"The one marked 
	[a class=extlink href=https://archive.org/details/megamanpc-tas-1_46_941/megamanpc-tas-1_46_941-soundhack.mp4 rel=nofollow 
		""soundhack"
	]a
	$LF
	"is the one I recommend to watch.
	$LF
	"It has been slowed down to a watchable speed while preserving sound effects
	$LF
	"(more about this in the comments below).
	$LF
	"It's about 9 minutes long.
	$LF
]p
[h3 id=Gameobjectives
 
	" Game objectives
	$LF
]h3
[ul 
	[li 
		" Emulator used: JPC-RR 11.6-WIP (
		[a class=extlink href=https://repo.or.cz/jpcrr.git/shortlog/bf3a341ad233439e21a32f33dffc1e730668121d rel=nofollow 
			"bf3a341ad233439e21a32f33dffc1e730668121d
		]a
		"); also syncs on 11.2
		$LF
	]li
	[li 
		" Aims for fastest time
		$LF
	]li
	[li 
		" Takes damage to save time
		$LF
	]li
	[li 
		" Manipulates luck
		$LF
	]li
]ul
[table 
	[tbody 
		[tr 
			[th 
				" 
			]th
			[th 
				[a class=intlink href=/2247M 
					"2247
				]a
				" 
			]th
			[th 
				" this
			]th
			[th 
				" diff
			]th
		]tr
		[tr 
			[td 
				"boot               
			]td
			[td 
				"    91
			]td
			[td 
				"   64
			]td
			[td 
				"   −27
			]td
		]tr
		[tr 
			[td 
				"configuration menu 
			]td
			[td 
				"     3
			]td
			[td 
				"    2
			]td
			[td 
				"    −1
			]td
		]tr
		[tr 
			[td 
				"title screen       
			]td
			[td 
				"   127
			]td
			[td 
				"  120
			]td
			[td 
				"    −7
			]td
		]tr
		[tr 
			[td 
				"intro stage        
			]td
			[td 
				"   386
			]td
			[td 
				"  375
			]td
			[td 
				"   −11
			]td
		]tr
		[tr 
			[td 
				"stage select SVD   
			]td
			[td 
				"   146
			]td
			[td 
				"  142
			]td
			[td 
				"    −4
			]td
		]tr
		[tr 
			[td 
				"Sonic Man stage    
			]td
			[td 
				"  2040
			]td
			[td 
				" 1901
			]td
			[td 
				"  −139
			]td
		]tr
		[tr 
			[td 
				"Sonic Man          
			]td
			[td 
				"   111
			]td
			[td 
				"  100
			]td
			[td 
				"   −11
			]td
		]tr
		[tr 
			[td 
				"stage select _VD   
			]td
			[td 
				"   352
			]td
			[td 
				"  344
			]td
			[td 
				"    −8
			]td
		]tr
		[tr 
			[td 
				"Volt Man stage     
			]td
			[td 
				"  2125
			]td
			[td 
				"  186
			]td
			[td 
				" −1939
			]td
		]tr
		[tr 
			[td 
				"Volt Man           
			]td
			[td 
				"   109
			]td
			[td 
				"   98
			]td
			[td 
				"   −11
			]td
		]tr
		[tr 
			[td 
				"stage select _
				[em 
				]em
				"_D   
			]td
			[td 
				"   305
			]td
			[td 
				"  295
			]td
			[td 
				"   −10
			]td
		]tr
		[tr 
			[td 
				"Dyna Man stage     
			]td
			[td 
				"  1988
			]td
			[td 
				" 1767
			]td
			[td 
				"  −221
			]td
		]tr
		[tr 
			[td 
				"Dyna Man           
			]td
			[td 
				"    77
			]td
			[td 
				"   52
			]td
			[td 
				"   −25
			]td
		]tr
		[tr 
			[td 
				"Wily title cards   
			]td
			[td 
				"   363
			]td
			[td 
				"  351
			]td
			[td 
				"    −12
			]td
		]tr
		[tr 
			[td 
				"Wily stage         
			]td
			[td 
				"  1734
			]td
			[td 
				" 1661
			]td
			[td 
				"   −73
			]td
		]tr
		[tr 
			[td 
				"Wily               
			]td
			[td 
				"   104
			]td
			[td 
				"   38
			]td
			[td 
				"   −66
			]td
		]tr
		[tr 
			[td 
				[b 
					"total
				]b
				"          
			]td
			[td 
				" 
				[b 
					"10061
				]b
			]td
			[td 
				" 
				[b 
					"7496
				]b
			]td
			[td 
				" 
				[b 
					"−2565
				]b
			]td
		]tr
	]tbody
]table
[p 
	"As a secondary entertainment goal, I try to make 1-ups drop as often as possible.
	$LF
	"They are normally a 1/64 chance.
	$LF
	"I get nine 1-ups to drop from 32 drop-capable kills, though I can only collect five of them without slowing down.
	$LF
]p
[h3 id=Generalcomments
 
	" General comments
	$LF
]h3
[p 
	"I used a number of helper programs.
	$LF
	"The most important of these were a HUD/memory watch script
	$LF
	"and an optimization script.
	$LF
]p
[p 
	"The HUD script shows enemy HP and hitboxes, as well as other information scraped from memory.
	$LF
	"It predicts upcoming RNG values, which is how I knew when a 1-up drop was possible.
	$LF
	"There are some stage-specific outputs; for example this screenshot
	$LF
	"shows the HP of the two destructible walls in Sonic Man's stage.
	$LF
]p
[p 
	[img alt=A screenshot of the game with the HUD script activated. Mega Man is in the first room of Sonic Man's stage, jumping to the left after having destroyed the first of two walls. A Frogbot jumps rightward into the wall's explosion. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-hud.png 
	]img
	$LF
	[img alt=A screenshot of the floating HUD window, showing current values of "Megaman x", "Megaman y", "Megaman dx", "Megaman dy", "Megaman flags", "Weapon counter", "Current sound", "Stage", "RNG →", "Next 1up", "explosion ctr", "wall 1 HP", and "wall 2 HP". class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-hud-window.png 
	]img
	$LF
]p
[p 
	"The optimization script automates the testing
	$LF
	"of many input sequences within a search space you define.
	$LF
	"It loads a savestate, runs an input sequence,
	$LF
	"and scores the outcome based on some evaluation function.
	$LF
	"You may say, for example, "try jumping after between 2 and 5 frames,
	$LF
	"try grabbing the ladder after between 6 and 10 frames,
	$LF
	"and rank the outputs by Mega Man's 
	[em 
		"y
	]em
	" position."
	$LF
	"There are more details about the script 
	[a class=intlink href=/Forum/P/477849#477849 
		"here
	]a
	".
	$LF
	"I used it in 46 places, including on all the jumps around corners,
	$LF
	"which are tricky to optimize manually.
	$LF
	"The optimization script accounts for the large number of rerecords;
	$LF
	"some of the runs tried thousands of candidate input sequences.
	$LF
	"Here is what it looks like, optimizing a jump into a ladder grab:
	$LF
]p
[p 
	[img alt=An animation of Mega Man repeatedly jumping for the same ladder, with minor variations each time. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-optimize-batcave.gif 
	]img
	$LF
]p
[p 
	"A consideration in this game is sub-tile alignment.
	$LF
	"Tiles are 16 pixels wide.
	$LF
	"Mega Man accelerates in units of 2 pixels per frame,
	$LF
	"up to a maximum speed of 8 pixels per frame. (There are no subpixels.)
	$LF
	"Getting damaged sets your speed to −2 pixels per frame.
	$LF
	"This all means that under normal circumstances, if you have even pixel alignment, it will stay even;
	$LF
	"and if you have odd alignment, it will stay odd.
	$LF
	"The only way to change your alignment is to run into a wall
	$LF
	"(going left makes the alignment even; going right makes it odd)
	$LF
	"or to grab a ladder (makes it even).
	$LF
	"Alignment matters for many small optimizations;
	$LF
	"for example, being 2 pixels behind may allow you to start moving one frame earlier,
	$LF
	"which gives an advantage of 6 pixels overall.
	$LF
	"Mega Man moves at 8 pixels per frame at full speed,
	$LF
	"meaning that you'll have the same half-time alignment in every frame,
	$LF
	"unless you slow down.
	$LF
]p
[p 
	"The game's RNG iterates at least once per frame.
	$LF
	"Random item drops and enemy AI can cause it to iterate more.
	$LF
	"Each stage has a fixed seed value to which the RNG state is reset
	$LF
	"when the stage starts; that is,
	$LF
	"RNG sequences do not carry across stages.
	$LF
]p
[p 
	"The game is frame-oriented for the most part,
	$LF
	"running one iteration of the game loop per vertical refresh.
	$LF
	"But input is interrupt-driven: the global variable
	$LF
	"representing the current state of input may change in the middle of a frame.
	$LF
	"Sub-frame inputs are occasionally useful.
	$LF
	"Pressing and releasing Space in the same frame allows you to shoot on every frame.
	$LF
	"Pressing or releasing two keys in the proper order is key to switching
	$LF
	"weapons without losing time on the pause screen.
	$LF
	"At the stage select and at the beginning of stages,
	$LF
	"it is sometimes possible to save 1 frame by locating the first input
	$LF
	"late in the frame 
	[em 
		"before
	]em
	" it appears that the game first accepts input.
	$LF
]p
[h3 id=Bootandconfigurationmenu
 
	" Boot and configuration menu
	$LF
]h3
[p 
	"This run puts the game files on hard disk HDD rather than HDA (saves 27 frames).
	$LF
	"It then loads fdconfig.sys, which costs 5 frames here but
	$LF
	[a class=intlink href=/Forum/P/479399#479399 
		"saves 85 frames in load times
	]a
	" later on.
	$LF
]p
[p 
	"The configuration menu is not frame-oriented, unlike the game itself.
	$LF
	"It's just a loop that polls a global variable that is set
	$LF
	"by the keyboard interrupt handler.
	$LF
	"This means that you can provide inputs much faster than one per frame—but you
	$LF
	"have to go slow enough that the loop notices one of your inputs before
	$LF
	"you provide the next one.
	$LF
	"Input is recognized when a key is released, not when it is pressed,
	$LF
	"so we start by pressing all the keys we will need, before the menu appears.
	$LF
	"Then it's a matter of trying each key press/release at a certain time,
	$LF
	"checking if it was recognized, and going back to slightly increase the delay if not.
	$LF
	(__wikiLink|/2247M|2247M)
	" also used sub-frame inputs here,
	$LF
	"but this submission spaces the inputs more closely,
	$LF
	"saving 1 frame.
	$LF
]p
[p 
	"The stage select screen changes when you release a key, not when you press it.
	$LF
	"We take advantage of this by pressing and holding Left and Enter
	$LF
	"well before the stage select screen appears,
	$LF
	"then releasing both keys at the earliest time when the input is accepted
	$LF
	"(which will generally be a sub-frame input).
	$LF
]p
[h3 id=SonicMan
 
	" Sonic Man
	$LF
]h3
[p 
	"The jump down to the first room illustrates a recurring theme:
	$LF
	"pre-jumping before descents,
	$LF
	"and managing horizontal position to clip corners
	$LF
	"as early as possible at maximum speed.
	$LF
	"We jump before reaching the pit so that Mega Man
	$LF
	"is already moving at his maximum vertical velocity of 15 pixels per frame
	$LF
	"as soon as the floor is gone.
	$LF
	"On the way down, we adjust 6 pixels to the right so that,
	$LF
	"3 frames later,
	$LF
	"we can start moving to the right again at maximum speed
	$LF
	"and just barely avoid bonking Mega Man's head (which would set his horizontal speed to 0).
	$LF
	"It turns out that in this case an adjustment of 6 pixels is optimal.
	$LF
	"If we had adjusted only 4 pixels, we would be 2 pixels
	$LF
	"behind at the same frame;
	$LF
	"whereas if we had adjusted 8 pixels,
	$LF
	"we would have bonked, or else be forced
	$LF
	"to wait an extra frame before starting to move,
	$LF
	"costing even more time.
	$LF
	"(Recall that it's not possible to change Mega Man's position by an odd number of pixels
	$LF
	"except in special situations.)
	$LF
	"All jumps like this were done using the optimization script
	$LF
	"to test many combinations
	$LF
	"of jump height, stop-moving-right time, horizontal adjustment,
	$LF
	"and start-moving-right time.
	$LF
]p
[p 
	"The first room in the stage is tricky to optimize.
	$LF
	"We must destroy two walls, each of which has 8 HP.
	$LF
	"After a wall is destroyed, it explodes for 28 frames,
	$LF
	"and during that time, the other wall is invulnerable.
	$LF
	"(This is the case for all such explosions in the game.
	$LF
	"There is only one instance of the global explosion object,
	$LF
	"so the game takes care that no more than one explosion can occur at a time.)
	$LF
	"During these 28 frames of downtime, we lure the Batvire
	$LF
	"toward the left to open up some space;
	$LF
	"then destroy the second wall.
	$LF
	"We make the final shot land up high,
	$LF
	"so that Mega Man can walk underneath the second explosion.
	$LF
]p
[p 
	"The fan shaft is one of very few places in the game with
	$LF
	[a class=extlink href=https://tcrf.net/Mega_Man_(DOS)#Gravity rel=nofollow 
		"zero or negative gravity
	]a
	".
	$LF
	"In these places, you can influence Mega Man's vertical speed
	$LF
	"by pressing the Up and Down keys.
	$LF
	"Here, we ascend 1 frame faster by pressing Up
	$LF
	"to instantly accelerate from a speed of −7 (from the jump)
	$LF
	"to −15, Mega Man's terminal velocity.
	$LF
	"Without pressing Up, Mega Man's speed goes from −7, to −11,
	$LF
	"and then to −15.
	$LF
]p
[p 
	"The next room, with the wall blasters,
	$LF
	"is the first damage-boost.
	$LF
	"The Sewer Rat cannot be hit with the Buster except when it stands,
	$LF
	"and it would take too much time to wait for it to stand.
	$LF
	"Instead, we destroy one of the wall blasters
	$LF
	"and take damage from its explosion to walk past it.
	$LF
	"(Incidentally, this room is also the easiest place to demonstrate that there
	$LF
	"can only be one explosion at a time.
	$LF
	"Shoot one wall blaster, then shoot a second while the first is exploding—the
	$LF
	"second one will not be damaged.)
	$LF
]p
[p 
	"In the large room, we collect the E Tank that we'll
	$LF
	"need for the skip in Volt Man's stage.
	$LF
	"I never knew how to collect this E Tank—it's too high to jump to—until
	$LF
	"after I had reverse engineered
	$LF
	"the map format and uncovered one of the game's dirtiest secrets:
	$LF
	"two of the pipe tiles are actually ladders.
	$LF
	"The tiles are duplicates of pipe tiles used elsewhere in the stage,
	$LF
	"but they additionally have the "climbable" bit set.
	$LF
	"These are the only two such tiles in the game.
	$LF
	"Here they are highlighted:
	$LF
]p
[p 
	[img alt=A screenshot of the platform holding the E Tank, with the two climbable pipe tiles highlighted. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-sonicman-pipe-ladder.png 
	]img
	$LF
]p
[p 
	"The wall in the lower right of the large room looks
	$LF
	"just like the destructible walls in the first room,
	$LF
	"but it is only vulnerable to Nuclear Detonator (Dyna Man's weapon).
	$LF
	"Even if we could get through it, it wouldn't save time.
	$LF
	"When you go that way, the game
	$LF
	"dynamically erects an indestructible wall (not part of the
	$LF
	[a class=extlink href=https://www.bamsoftware.com/computers/tasvideos/mmdos-sonic.map.16.png? rel=nofollow 
		"map data
	]a
	")
	$LF
	"in the large chamber to prevent you from going any farther.
	$LF
]p
[p 
	"The underwater sections have reduced gravity (you can jump higher)
	$LF
	"and horizontal drag, reducing Mega Man's maximum speed to 6 pixels per second.
	$LF
	"It pays to be above the surface of the water as much as possible.
	$LF
	"There is a cost, though, whenever Mega Man jumps from a lower to a higher platform:
	$LF
	"he freezes in place while waiting for the camera to recenter on him vertically.
	$LF
	"It doesn't happen when jumping down.
	$LF
	"Camera recentering delay is a concern throughout the game.
	$LF
	"In a couple of places here I was able to avoid it
	$LF
	"by only touching a platform for 1 frame,
	$LF
	"but I couldn't make the same trick work elsewhere.
	$LF
]p
[p 
	"The Piranhas' spawns are random.
	$LF
	"While optimizing this section, I ran into situations where I could
	$LF
	"not avoid a Piranha without slowing down.
	$LF
	"When that happened, I went back and killed a Sewer Rat to tweak the RNG.
	$LF
	"Killing a Sewer Rat affects the RNG in two ways:
	$LF
	"the random drop iterates the RNG once; but also,
	$LF
	"the Sewer Rats use the RNG while they are alive
	$LF
	"to decide how long to walk and how long to stand.
	$LF
]p
[p 
	"The fireball ladder at the end puts a limit,
	$LF
	"I believe, on how quickly the underwater section can be done.
	$LF
	"Getting there a few frames earlier would just mean waiting longer to avoid a fireball,
	$LF
	"unless early enough to hit an earlier cycle.
	$LF
]p
[p 
	"In the large, dark room filled with Batvires,
	$LF
	"you'll see a mitigation against vertical camera recentering delay.
	$LF
	"Jumping at the top of a ladder partially scrolls the camera up,
	$LF
	"leaving it less distance to move when you touch the ground again.
	$LF
	"This doesn't help unless Mega Man has a certain amount of headroom,
	$LF
	"but I do it on all ladders for consistency
	$LF
	"and because it looks cool.
	$LF
	"It saves up to 3 frames per ladder.
	$LF
]p
[p 
	[img alt=A split-screen animation comparing Mega Man jumping at the top of a ladder, and not jumping. The jumping one is a tile and a half faster. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-ladder-jump.gif 
	]img
	$LF
]p
[p 
	"There's a little bit of downtime at the disappearing blocks
	$LF
	"at the end of the stage while we wait for the cycle to finish.
	$LF
	"It's barely perceptible, but while waiting we adjust 2 pixels to the right—that's
	$LF
	"as far right as we can go without bonking on the final jump.
	$LF
	"At normal running speed, Mega Man moves at 8 pixels per frame.
	$LF
	"Fine adjustments of 2, 4, or 6 pixels are only possible after stopping
	$LF
	"for at least 1 frame, so we can only use them
	$LF
	"at forced stopping points like this.
	$LF
]p
[p 
	"Bosses, like other enemies, have no invincibility frames.
	$LF
	"The strategy in the Sonic Man fight is to shoot as early as possible,
	$LF
	"get close as soon as possible, and then shoot on every frame.
	$LF
	"If you are too far away from Sonic Man, you cannot shoot on every frame
	$LF
	"because the Buster has a limit of 3 shots at a time.
	$LF
	"After the battle, we jump in order to shorten the
	$LF
	"animation of the falling code key.
	$LF
]p
[h3 id=VoltMan
 
	" Volt Man
	$LF
]h3
[p 
	"The skip in Volt Man's stage is possible because
	$LF
	[a class=extlink href=https://www.bamsoftware.com/computers/tasvideos/mmdos-volt.map.16.png? rel=nofollow 
		"the end of the stage is close to the start
	]a
	",
	$LF
	"separated only by a row of instant-death tiles.
	$LF
	"Contact with a death tile instantly reduces your health to zero.
	$LF
	"All spikes and bottomless pits in the game work like this,
	$LF
	"using specially marked map tiles.
	$LF
	"Here I've highlighted them:
	$LF
]p
[p 
	[img alt=A screenshot of Mega Man falling toward the death barrier in Volt Man's stage, with the death tiles highlighted. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-voltman-death-barrier.png 
	]img
	$LF
]p
[p 
	"The trick is that you can pause on the same frame that your health is drained,
	$LF
	"and use an E Tank to refill your health.
	$LF
	[a class=intlink href=/Forum/P/471729#471729 
		"I initially thought
	]a
	" that it would require four E Tanks,
	$LF
	"because it takes four frames to pass completely through the barrier.
	$LF
	"But a small refinement makes it require only one:
	$LF
	"take damage from a spark on the way down, so that
	$LF
	"you stagger backwards against the wall.
	$LF
	"For some reason this means you get hurt only once.
	$LF
]p
[p 
	"The skip is pretty easy to do even in an RTA run.
	$LF
	"I wrote a description of how to do it in
	$LF
	[a class=extlink href=https://archive.org/details/Mega_Man_DOS_speedrun_11_21_20180711_David_Fifield rel=nofollow 
		"my run
	]a
	$LF
	"and kavoc has done it in
	$LF
	[a class=extlink href=https://www.speedrun.com/Mega_Man_DOS/run/y43oqjkz rel=nofollow 
		"his recent WR runs
	]a
	".
	$LF
]p
[p 
	"I thoroughly computer-optimized the skip for the TAS.
	$LF
	"You want to be as far to the right as possible, but not so far that you don't reach the wall after being damaged.
	$LF
	"You want to drop through the wire early, so
	$LF
	"you start accelerating as soon as possible,
	$LF
	"but not so early that the spark doesn't hit you.
	$LF
	"The optimization script tested 1,500 different combinations
	$LF
	"of position and timing
	$LF
	"and settled on this as the best one.
	$LF
]p
[p 
	"Normally, Raptorbots don't spawn in this part of the level,
	$LF
	"but in this case they do, because we skipped the trigger
	$LF
	"that turns them off.
	$LF
	"It's good for us, too, because we can use them for RNG manipulation.
	$LF
	"Volt Man can randomly jump either high or low,
	$LF
	"and a low jump saves 2 frames.
	$LF
	"We kill one of the Raptorbots to advance the RNG by one step,
	$LF
	"which is just enough to make Volt Man do a low jump.
	$LF
]p
[p 
	"The strategy against Volt Man is easy.
	$LF
	"Let him damage you, and use your invulnerability to
	$LF
	"get into position to shoot as soon as his shield is gone.
	$LF
	"It's essential to be close enough that your shots hit on the same frame that you shoot,
	$LF
	"because you can only have one Sonic Wave onscreen at a time.
	$LF
	"As a small optimization, you get one free shot before the fight starts.
	$LF
]p
[h3 id=DynaMan
 
	" Dyna Man
	$LF
]h3
[p 
	"The best weapon to use in Dyna Man's stage is Force Field.
	$LF
	"Not only is it Dyna Man's weakness,
	$LF
	"it's effective against most of the stage's enemies and hazards,
	$LF
	"including the nails dropped by Sentry Bees (though not the bees themselves).
	$LF
	"We switch to Sonic Wave a couple of times to get some 1-up drops,
	$LF
	"because it reflects backwards after hitting a wall.
	$LF
	"Switching weapons is free (costs zero time) if done properly,
	$LF
	"and as long as you are only moving and not trying to do anything else.
	$LF
	"To switch to Sonic Wave, for example:
	$LF
	"press S, press Esc, frame advance; release S, release Esc, frame advance.
	$LF
	"Mega Man will continue moving at full speed during both of these frames.
	$LF
]p
[p 
	"The jumps over crates in this stage are difficult to optimize.
	$LF
	"The beginning section of Dyna Man's stage really exercised the optimization script.
	$LF
]p
[p 
	"Backwards conveyor belts push Mega Man back at 4 pixels per frame,
	$LF
	"cutting his running speed in half.
	$LF
	"We use lots of one-frame jumps over backwards conveyors,
	$LF
	"to touch the ground as little as possible.
	$LF
	"Forward conveyors do not make Mega Man run faster than his normal speed
	$LF
	"of 8 pixels per frame,
	$LF
	"so there's no advantage to landing on them early.
	$LF
	"On either side of every conveyor belt there are single tiles
	$LF
	"that you can pass through like air, but which push in the same direction
	$LF
	"as the conveyor.
	$LF
	"(Just like the horizontal drag under water in Sonic Man's stage.)
	$LF
	"You have to know to avoid the extra tiles, or you'll suddenly have lost
	$LF
	"4 pixels without knowing why.
	$LF
]p
[p 
	"The bottomless pits in this stage are not really bottomless.
	$LF
	"They
	$LF
	[a class=extlink href=https://www.bamsoftware.com/computers/tasvideos/mmdos-dyna.map.16.png? rel=nofollow 
		"connect to a later part of the level
	]a
	$LF
	"through a death barrier,
	$LF
	"just like in Volt Man's stage.
	$LF
	"If we had another E Tank, we would use it at one of these pits for another major skip.
	$LF
	"But we have only one E Tank, and it saves more time in Volt Man's stage
	$LF
	"than it would in this stage.
	$LF
	"We could farm a second E Tank in Sonic Man's stage
	$LF
	"(the only other E Tank in the game is in the middle of Volt Man's stage),
	$LF
	"but it would take more time to do that than it would save here (I think).
	$LF
]p
[p 
	"At the disappearing blocks over the lava pit,
	$LF
	"we have to wait a bit for the cycle to develop.
	$LF
	"Notice how we jump over the high block to avoid a vertical camera recentering delay.
	$LF
	"We take advantage of the forced wait to adjust 2 pixels to the left,
	$LF
	"so as to be as far forward as possible once out of the pit.
	$LF
	"In the next section, the Force Field protects against
	$LF
	"lava bubbles and acid drops,
	$LF
	"so the only concern is to avoid bonks
	$LF
	"and low-to-high jumps which would cause camera recentering.
	$LF
]p
[p 
	"The hazards on the assembly line at the bottom of the stage
	$LF
	"are unkillable, and the Force Field does not protect against them.
	$LF
	"Taking damage is faster than waiting for an opening,
	$LF
	"as long as you face left before getting hit.
	$LF
	"When hurt, Mega Man staggers backwards at 2 pixels per frame.
	$LF
	"Combine that with the conveyor moving at 4 pixels per frame,
	$LF
	"and you move at 6 pixels per frame while incapacitated from damage,
	$LF
	"which is still 75% of Mega Man's running speed.
	$LF
]p
[p 
	"Dyna Man's AI is randomized like Volt Man's, but harder to manipulate.
	$LF
	"His initial jump is random in both horizontal and vertical components.
	$LF
	"He can jump toward you with a speed of 4, 5, 6, or 7 pixels per frame,
	$LF
	"and he can jump upward with a speed of 7, 9, 11, or 13 pixels per frame.
	$LF
	"His horizontal speed matters because Force Field only works when up close—you
	$LF
	"want the distance between you and him
	$LF
	"to close as quickly as possible.
	$LF
	"His vertical speed matters for the same reason—at higher speeds
	$LF
	"he jumps higher than you can reach, and you have to wait for him to come down.
	$LF
	"The HUD script predicts the next few jump velocities,
	$LF
	"so when you get there you know how many additional RNG values you need to burn
	$LF
	"as you redo the stage in order to get a favorable jump.
	$LF
	"In an 
	[a class=intlink href=/Forum/P/477849#477849 
		"earlier draft
	]a
	", I had to kill a random Sentry Bee
	$LF
	"in the middle of the stage.
	$LF
	"But in this submission, by a lucky coincidence, the two Sentry Bees I kill
	$LF
	"at the beginning of the stage for 1-up drops provide the right RNG
	$LF
	"at the end of the stage to get a good jump speed of (7, 9).
	$LF
]p
[p 
	"Dyna Man's weakness is Force Field, which does 6 damage per hit,
	$LF
	"requiring 6 hits overall.
	$LF
	"We can reduce that by shooting with the Buster until we're close enough
	$LF
	"to use Force Field.
	$LF
	"There's just enough time to land 4 Buster shots for 8 total damage,
	$LF
	"which reduces the number of required Force Field shots to 4.
	$LF
	"To fight with the Force Field, overlap your hitbox with Dyna Man's,
	$LF
	"and toggle the shot every frame (press and release Space in the same frame).
	$LF
]p
[h3 id=Wily
 
	" Wily
	$LF
]h3
[p 
	"It's just good luck that
	$LF
	"the RNG lines up to make it possible to get three 1-ups
	$LF
	"in a row in this opening hallway.
	$LF
	"Because every stage including Wily's starts with its own fixed RNG seed
	$LF
	"it's perfectly repeatable,
	$LF
	"no matter what happened in earlier stages.
	$LF
	"It's not as easy as it looks, though:
	$LF
	"you have to hit enemies that are not in front of you,
	$LF
	"which means using the Force Field, and
	$LF
	"you have to manage the phase of the Force Field
	$LF
	"(the size of its hitbox depends on its phase)
	$LF
	"to avoid killing an enemy a frame too early or late.
	$LF
]p
[p 
	"In the refight against Sonic Man, we get to use his weakness, Nuclear Detonator.
	$LF
	"This weapon is so slow and awkward—after shooting,
	$LF
	"you have to wait for 16 frames before you can detonate it—that I initially dismissed it completely.
	$LF
	"However, I learned from 
	[a class=extlink href=https://www.youtube.com/watch?v=27EJ3yLZG9k rel=nofollow 
		"this let's play
	]a
	" by Psychedelic Eyeball
	$LF
	"that it's possible to hit Sonic Man twice with the same shot,
	$LF
	"which makes it overall faster than the other weapons.
	$LF
	"I computer-optimized this fight to find the earliest and highest point
	$LF
	"at which to launch the Nuclear Detonator.
	$LF
	"Even so, we are left with a few frames of downtime while waiting for the boss to die,
	$LF
	"which we use to fix our sub-tile alignment to a multiple of 8.
	$LF
]p
[p 
	"Next, there is some tricky RNG manipulation.
	$LF
	"Both of the next two bosses have randomized AI—we
	$LF
	"want a low jump from Volt Man (1/2 chance),
	$LF
	"and ideally a fast (1/4 chance) and low (1/2 chance)
	$LF
	"jump from Dyna Man.
	$LF
	"We are limited in the amount of manipulation we can do;
	$LF
	"in this section the only options are to wait, or kill a different number of enemies.
	$LF
	"There are up to 10 killable enemies in the section before Volt Man (the 3 mosquitoes respawn),
	$LF
	"and you can kill up to 2 Sentry Bees in the section before Volt Man.
	$LF
	"Unfortunately the RNG values don't quite line up:
	$LF
	"any way I could find to get the fastest jump from Dyna Man
	$LF
	"would also leave Volt Man doing a high jump.
	$LF
	"I settled for a low jump from Volt Man
	$LF
	"and a second-fastest jump from Dyna Man.
	$LF
]p
[p 
	"The Volt Man refight is the same as the first fight.
	$LF
	"After killing the boss, your absolute horizontal position doesn't matter:
	$LF
	"as long as you are standing on the left half of the screen,
	$LF
	"the sum of the horizontal camera recentering delay and the time needed to run to the exit door is constant.
	$LF
	"(The camera moves at the same speed Mega Man does.)
	$LF
	"The only exception is sub-tile alignment.
	$LF
	"If Mega Man's position is not a multiple of 8 pixels,
	$LF
	"the camera will take 1 extra frame to align itself.
	$LF
	"There's plenty of time to get our sub-tile alignment right
	$LF
	"while waiting for Volt Man to become vulnerable.
	$LF
]p
[p 
	"The Dyna Man refight is unlike the Sonic Man and Volt Man refights,
	$LF
	"in that we're not waiting for something to happen.
	$LF
	"We can kill the boss just as soon as we can reach him.
	$LF
	"So in this case Mega Man's absolute horizontal position does matter:
	$LF
	"it pays to kill him as close to the center of the screen as possible,
	$LF
	"to minimize horizontal camera recentering delay.
	$LF
]p
[p 
	"The Force Field makes you immune to the bullets of Sniper Joes and Mets,
	$LF
	"so the final hallway offers no challenge.
	$LF
	"The only noteworthy feature is the background tiles that look like yellow light bulbs.
	$LF
	"These tiles have a 
	[a class=extlink href=https://tcrf.net/Mega_Man_(DOS)#Gravity rel=nofollow 
		"zero-gravity property
	]a
	",
	$LF
	"similar to the fan shaft in Sonic Man's stage in that you can control Mega Man's
	$LF
	"vertical speed with the Up and Down keys.
	$LF
	"Here I act like I'm going to fall into a bullet,
	$LF
	"but then float away.
	$LF
]p
[p 
	"The final boss is a walking supercomputer called Crorq,
	$LF
	"revealed in its second phase to be piloted by Dr. Wily.
	$LF
	"The first phase takes 6 shots of Sonic Wave,
	$LF
	"which we fire while charging toward the enemy to minimize shot travel time.
	$LF
	"The second phase goes down 5 frames later:
	$LF
	"1 frame to switch weapons, then 4 shots of Force Field.
	$LF
	"The final micro-optimization is
	$LF
	"not to release Space
	$LF
	"after delivering the final blow
	$LF
	"(saves 0.00067 s).
	$LF
]p
[h3 id=Othercomments
 
	" Other comments
	$LF
]h3
[h4 id=Soundandframerate
 
	" Sound and framerate
	$LF
]h4
[p 
	"The game runs way too fast to be watchable,
	$LF
	"even on JPC-RR's slowest CPU settings.
	$LF
	"This was a problem with 
	(__wikiLink|/2247M|2247M)
	" as well.
	$LF
	"I think anyone would prefer watching its
	$LF
	[a class=extlink href=http://www.youtube.com/watch?v=vhTPA2EfvkM rel=nofollow 
		"slowed-down encode
	]a
	$LF
	"over the full-speed video.
	$LF
]p
[p 
	"The only problem with the slowed-down encode is that it alters the sound effects,
	$LF
	"making them lower-pitched and longer in duration.
	$LF
	"To fix this problem, I made a special "soundhack" encode
	$LF
	"(named after the camhacks in e.g. 
	(__wikiLink|/3584M|3584M)
	")
	$LF
	"that hacks the game binary to increase the pitch and decrease the duration
	$LF
	"of sound effects, so that they sound approximately correct when slowed back down again.
	$LF
	"You lose some of the high frequencies this way, but it sounds a lot better
	$LF
	"than just slowing everything down.
	$LF
]p
[p 
	"The necessary
	$LF
	[a class=extlink href=https://archive.org/download/megamanpc-tas-1_46_941/soundhack.py rel=nofollow 
		"soundhack.py
	]a
	$LF
	"script is in the source code repo and linked on the video encode page.
	$LF
	"Inside of mm.exe, there is a table of sound effects,
	$LF
	"each one an array of frequencies.
	$LF
	"The script multiplies each frequency by a factor of 5,
	$LF
	"and speeds up the programmable interval timer (PIT) by the same factor of 5.
	$LF
	"The PIT controls the duration of sound effects and nothing else, so it doesn't affect sync.
	$LF
	"Why a factor of 5?
	$LF
	"This was to make the slowed-down encode approximately comparable to the
	$LF
	[a class=extlink href=https://www.speedrun.com/Mega_Man_DOS rel=nofollow 
		"RTA runs at speedrun.com
	]a
	",
	$LF
	"which use DOSBox with 
	[tt 
		"cycles=500
	]tt
	".
	$LF
	"I timed 10 Mega Man blink cycles in JPC-RR and DOSBox,
	$LF
	"and found that the ratio was very close to 5.
	$LF
]p
[p 
	"To do the sound hack encode, I ran these commands:
	$LF
]p
[pre 
	"dumpconvert.exe --video-width=640 --video-height=384 --output-x264=megamanpc-soundhack_video.mp4 \
	$LF
	"  --video-max-dedup=0 --output-timecodev2=megamanpc-soundhack_times.txt megamanpc-soundhack.jmd
	$LF
	"dumpconvert.exe --audio-mixer-attenuate=org.jpc.emulator.peripheral.PCSpeaker-0:10 \
	$LF
	"  --output-wav=megamanpc-soundhack_audio.wav megamanpc-soundhack.jmd
	$LF
	"ffmpeg -r $(
	[em 
	]em
	"(125875/5)
	[em 
	]em
	")/1796 -i megamanpc-soundhack_video.mp4 -i megamanpc-soundhack_audio.wav \
	$LF
	"  -af asetrate=$(
	[em 
	]em
	"(44100/5)
	[em 
	]em
	") -ar 44100 -y megamanpc-soundhack.mp4
	$LF
]pre
[p 
	"Or, to embed soft captions in the video,
	$LF
]p
[pre 
	"ffmpeg -r $(
	[em 
	]em
	"(125875/5)
	[em 
	]em
	")/1796 -i megamanpc-soundhack_video.mp4 -i megamanpc-soundhack_audio.wav \
	$LF
	"  -f srt -i megamanpc-soundhack.mp4.en.srt -af asetrate=$(
	[em 
	]em
	"(44100/5)
	[em 
	]em
	") -ar 44100 -scodec mov_text \
	$LF
	"  -metadata:s:s:0 language=eng -y megamanpc-soundhack.mp4
	$LF
]pre
[p 
	"The 
	[a class=intlink href=/EmulatorResources/JPC/MovieDumping 
		"JPC-RR dumping guide
	]a
	" has additional steps to get the frame rate and resolution right for the text-mode parts, but I ignored that in my encodes.
	$LF
]p
[h4 id=Wallclip
 
	" Wall clip
	$LF
]h4
[p 
	"I found a clip/zip, but didn't find a use for it.
	$LF
	"While climbing a ladder, hold Right and J (jump).
	$LF
	"At the top of the ladder, release Up, and you'll clip one tile into the solid wall on the right.
	$LF
	"It doesn't work on the left, and I couldn't extend it past one tile.
	$LF
]p
[p 
	[img alt=An animation of Mega Man reaching the top of the long ladder in Dyna Man's stage, and clipping into the solid tile on the right. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-ladder-clip.gif 
	]img
	$LF
]p
[h4 id=Deathwarp
 
	" Death warp
	$LF
]h4
[p 
	"Trigger tiles are special map tiles that do something when Mega Man passes over them,
	$LF
	"for example spawning the enemies for the next room or activating a checkpoint.
	$LF
	"A minor death warp is possible with a least one checkpoint,
	$LF
	"where the checkpoint is located a tiny bit farther ahead in the stage.
	$LF
	"But it's such a small distance, and the death animation is so long, that it doesn't save time.
	$LF
	"However, I didn't investigate all checkpoints
	$LF
	"and there may be other opportunities.
	$LF
]p
[p 
	[img alt=An animation of Mega Man entering the bat cave in Sonic Man's stage, dying with F10, and respawning a few tiles down and to the left of where he was. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-sonicman-death-warp.gif 
	]img
	$LF
]p
[h4 id=Triggertilereentrancy
 
	" Trigger tile reentrancy
	$LF
]h4
[p 
	"I found a bug having to do with activating a trigger tile twice.
	$LF
	"After the fan shaft in Sonic Man's stage,
	$LF
	"there is a trigger tile in the downward tube
	$LF
	"that spawns the Sewer Rat and makes the wall blasters start shooting.
	$LF
	"The Sewer Rat AI is supposed to work like this:
	$LF
	"walk for rand(32, 64) frames, stand for rand(8, 16) frames, repeat.
	$LF
	"If you jump straight down into the room (touching the trigger tile only once),
	$LF
	"that is the behavior you'll see.
	$LF
	"But if you walk off the edge at an angle (touching the trigger tile twice),
	$LF
	"you'll instead see the rat walk for about 256 frames before starting
	$LF
	"its normal cycle.
	$LF
	"It happens because the rat gets reinitialized after it has already started its AI cycle,
	$LF
	"and an integer underflow occurs.
	$LF
	"Abusing the glitch doesn't help here,
	$LF
	"because you want the rat to stand anyway
	$LF
	"so it's easier to damage-boost past it.
	$LF
	"But possibly there are other such bugs in other places.
	$LF
]p
[h4 id=Outofbounds
 
	" Out of bounds
	$LF
]h4
[p 
	"After traversing the death barrier in Volt Man's stage,
	$LF
	"if you go left rather than right
	$LF
	"you'll end up out of bounds,
	$LF
	"off the left edge of the stage.
	$LF
	"There are some invisible solid platforms there.
	$LF
	"I tried for a while,
	$LF
	"but didn't find any way to save time
	$LF
	"or even get back in bounds.
	$LF
]p
[p 
	[img alt=An animation of Mega Man traversing the death barrier in Volt Man's stage using the E Tank trick, and moving left to stand atop the pole at the left of the stage. class=embed src=https://www.bamsoftware.com/computers/tasvideos/mmdos-voltman-1etank-skip.gif 
	]img
	$LF
]p
[h4 id=Joystickinput
 
	" Joystick input
	$LF
]h4
[p 
	"I didn't try joystick controls, only keyboard.
	$LF
	"It's possible that different input code paths could allow
	$LF
	"different sub-frame input opportunities.
	$LF
]p
[h3 id=Sourceanddata
 
	" Source and data
	$LF
]h3
[p 
	"The HUD and optimization scripts, as well as other random code and data, are available here:
	$LF
]p
[pre 
	"git clone !https://www.bamsoftware.com/git/megamanpc.git
	$LF
]pre
[h3 id=Thanks
 
	" Thanks
	$LF
]h3
[ul 
	[li 
		" James Fifield for a walkthrough.
		$LF
	]li
	[li 
		" LiteralGrill, whose 
		[a class=extlink href=https://www.speedrun.com/Mega_Man_DOS/run/m79k699y rel=nofollow 
			"former WR RTA run
		]a
		" showed me how to beat Volt Man, and to use the Force Field in Dyna Man's stage.
		$LF
	]li
	[li 
		" Psychedelic Eyeball, whose 
		[a class=extlink href=https://www.youtube.com/watch?v=27EJ3yLZG9k rel=nofollow 
			"let's play
		]a
		" showed me that Nuclear Detonator can work in the Sonic Man refight.
		$LF
	]li
	[li 
		" 
		[a class=intlink href=/Forum/R/5849 
			"c-square
		]a
		", 
		[a class=intlink href=/Forum/R/1312 
			"Dacicus
		]a
		", and 
		[a class=intlink href=/Forum/R/1503 
			"Patashu
		]a
		" for comments on the 
		[a class=intlink href=/Forum/T/9446 
			"Mega Man forum
		]a
		".
		$LF
	]li
	[li 
		" 
		[a class=extlink href=https://www.radare.org/r/ rel=nofollow 
			"Radare2
		]a
		", the tool I used for reverse engineering.
		$LF
	]li
	[li 
		" The 
		[a class=intlink href=/EmulatorResources/JPC 
			"JPC-RR documentation
		]a
		", this helped a lot.
		$LF
	]li
]ul
[hr 
]hr
[p 
	[a class=intlink href=/Users/Profile/feos 
		"feos
	]a
	": Judging...
	$LF
]p
[hr 
]hr
[p 
	[a class=intlink href=/Users/Profile/Sand 
		"Sand
	]a
	" 2018-12-27: Replaced the encode with one that is 55 frames faster
	$LF
	"because of 
	[a class=intlink href=/Forum/P/478544#478544 
		"shorter load times
	]a
	".
	$LF
	"The new input file is
	$LF
	[a class=extlink href=https://archive.org/download/megamanpc-tas-1_47_298/megamanpc-tas-1_47_298.jrsr rel=nofollow 
		"https://archive.org/download/megamanpc-tas-1_47_298/megamanpc-tas-1_47_298.jrsr
	]a
	".
	$LF
]p
[hr 
]hr
[p 
	[a class=intlink href=/Users/Profile/feos 
		"feos
	]a
	": Replaced the submission file with the above one.
	$LF
]p
[p 
	[a class=intlink href=/Users/Profile/feos 
		"feos
	]a
	": Fantastic movie, accepting as an improvement to 
	(__wikiLink|/2247M|2247M)
	".
	$LF
]p
[p 
	"Tier decision is tough. On one hand, the game runs too fast, there's no music, even the slowed down encode is hard to enjoy because this game feels like a sloppy hack. But it's a major improvement and the feedback really was good. I dare to upgrade this movie to Moons despite the fact that the old run is in Vault.
	$LF
]p
[p 
	[del 
		"Note to publisher: I'm still waiting for the author to reply regarding this movie's author name.
	]del
	$LF
]p
[hr 
]hr
[p 
	[a class=intlink href=/Users/Profile/Sand 
		"Sand
	]a
	" 2019-01-02: Is it too late to replace the input file again? I tested the 
	[a class=intlink href=/Forum/P/479331#479331 
		"late discovery
	]a
	" made in the forum, of loading fdconfig.sys but declining all the options, and it saves another 25 frames in load times. No gameplay changes. The new input file is 
	[a class=extlink href=https://archive.org/download/megamanpc-tas-1_46_941/megamanpc-tas-1_46_941.jrsr rel=nofollow 
		"https://archive.org/download/megamanpc-tas-1_46_941/megamanpc-tas-1_46_941.jrsr
	]a
	".
	$LF
]p
[hr 
]hr
[p 
	[a class=intlink href=/Users/Profile/feos 
		"feos
	]a
	": Replacing and keeping as accepted.
	$LF
]p
[p 
	"The name question has been resolved and this movie is ready for publication, with just the real name. The site doesn't seem to support lack of nickname on some pages, so I'm unsure about that field in the submission. When the submission gets published, it won't appear on the main page, only among published submissions, where both names can be seen, so I'm removing the nickname as the author preferred initially.
	$LF
]p
[p 
	(__wikiLink|/Dacicus|Dacicus)
	": Processing...
]p
